# This db checks the run state and manager mode and locks the PVs supplied in macros PV1-PV8
# via their .DISP field to disable db puts when not in manager mode or when an experiment is running
# 
# Example usage in a st-common.cmd:
# dbLoadRecords("$(UTILITIES)/db/disable_pv_puts.db", "INST=$(MYPVPREFIX),P=$(MYPVPREFIX)$(IOCNAME):,PV1=$(MYPVPREFIX)$(IOCNAME):<pv to be locked>,PV2=...,PV3=...PV8=...")
#
# Macros
# 
# P - prefix
# PV1-PV8 - PV macros for which puts should be disabled

record(calc, "$(P)_RUN_MAN_MON") {
    field(DESC, "Check run state and manager mode")
    field(INPA, "$(INST)DAE:RUNSTATE.RVAL CP") #isisdae ioc
    field(INPB, "$(INST)CS:MANAGER CP") # instetc ioc
    field(CALC, "A#1||B=0")
    field(FLNK, "$(P)_LOCK")
}

record(dfanout, "$(P)_LOCK") {
    field(DESC, "Toggle lock for PV puts")
    field(SELM, "All")
    field(OUTA, "$(PV1=$(P)_DUMMY_ACTION).DISP PP")
    field(OUTB, "$(PV2=$(P)_DUMMY_ACTION).DISP PP")
    field(OUTC, "$(PV3=$(P)_DUMMY_ACTION).DISP PP")
    field(OUTD, "$(PV4=$(P)_DUMMY_ACTION).DISP PP")
    field(OUTE, "$(PV5=$(P)_DUMMY_ACTION).DISP PP")
    field(OUTF, "$(PV6=$(P)_DUMMY_ACTION).DISP PP")
    field(OUTG, "$(PV7=$(P)_DUMMY_ACTION).DISP PP")
    field(OUTH, "$(PV8=$(P)_DUMMY_ACTION).DISP PP")
    field(DOL,  "$(P)_RUN_MAN_MON")
    field(OMSL, "closed_loop")
}

record(bo, "$(P)_DUMMY_ACTION") {
}